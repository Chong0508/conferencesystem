pipeline {
  agent any

  environment {
    BACKEND_DIR = "backend"
    FRONTEND_DIR = "frontend"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
        echo "Source code checked out successfully."
      }
    }

    stage('Backend: Unit Tests') {
      steps {
        echo "Running Spring Boot Unit Tests..."
        dir("${BACKEND_DIR}") {
          // Fixed typo: mvw -> mvnw
          sh """
              chmod +x mvnw
              ./mvnw clean test -B -Dmaven.test.failure.ignore=true
          """
        }
      }
      post {
        always {
          junit "${BACKEND_DIR}/target/surefire-reports/*.xml"
        }
      }
    }

    // Fixed typo: stages -> stage
    stage('Frontend: Build Check') {
      steps {
        echo "Installing dependencies and verifying Angular build..."
        dir("${FRONTEND_DIR}") {
          sh """
              npm install
              npm run build -- --configuration=production
          """
        }
      }
    }

    stage('Reports: Allure') {
      steps {
        echo "Generating Allure Report..."
        allure includeProperties: false,
               jdk: '',
               results: [[path: "${BACKEND_DIR}/target/allure-results"]]
      }
    }
  }

  post {
    always {
      echo "Cleaning up workspace..."
      cleanWs()
    }
    success {
      echo "Build Success! You can view the Allure Report on the left sidebar."
    }
    failure {
      echo "Build Failed. Please check the 'Console Output' or 'Allure Report' for details."
    }
  }
}